
@{
    ViewBag.Title = "OB Edit View";
}

    <div ng-app="RegistrationForm" ng-controller="Home">

        @*<div class="row page-titles">
            <div class="col-md-5 align-self-center">
                <h4 class="text-themecolor">Create Closing Balance</h4>
            </div>
            <div class="col-md-7 align-self-center">
                <div class="d-flex justify-content-end align-items-center">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
                        <li class="breadcrumb-item active">Create Closing Balance</li>
                    </ol>
                </div>
            </div>
        </div>*@
        <div id="DocNoNa" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="myLargeModalLabel">Select Document Lookup</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-7">

                            </div>
                            <div class="col-md-1">
                                <label for="CompSearch">Search:</label>
                            </div>
                            <div class="col-md-4 form-material">
                                <input type="text" class="form-control" id="UserSearch" ng-model="TypeDocSearch" />
                            </div>
                        </div>
                        <div class="table-responsive-sm">
                            <table class="table-sm table-hover table-bordered text-dark">
                                <thead>
                                    <tr>
                                        <th>Doc No</th>
                                        <th>Doc Date</th>
                                        <th>Site ID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="item in dtGetAll | filter:TypeDocSearch">
                                        <td><button ng-click="GetDocNa(item.DocNo)" class="btn btn-link" data-dismiss="modal">{{item.DocNo}}</button></td>
                                        <td>{{item.DocDate | date:dd-MMM-yyyy}}</td>
                                        <td>{{item.SiteID}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger waves-effect text-left" data-dismiss="modal">Close</button>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <div id="DocNoLookup" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="myLargeModalLabel">Select Document Lookup</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-7">

                            </div>
                            <div class="col-md-1">
                                <label for="CompSearch">Search:</label>
                            </div>
                            <div class="col-md-4 form-material">
                                <input type="text" class="form-control" id="UserSearch" ng-model="TypeSearch" />
                            </div>
                        </div>
                        <div class="table-responsive-sm">
                            <table class="table-sm table-hover table-bordered text-dark">
                                <thead>
                                    <tr>
                                        <th>Doc No</th>
                                        <th>Doc Date</th>
                                        <th>Site ID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="item in dtGetAll | filter:TypeSearch">
                                        <td><button ng-click="GetCF(item.DocNo)" class="btn btn-link" data-dismiss="modal">{{item.DocNo}}</button></td>
                                        <td>{{item.DocDate | date:dd-MMM-yyyy}}</td>
                                        <td>{{item.SiteID}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger waves-effect text-left" data-dismiss="modal">Close</button>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!--row-->
        @*===========================Main Form============================*@
        <!-- Main content -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <!-- left column -->
                    <div class="card-header bg-info">
                        <h4 class="m-b-0 text-white">Edit Closing Balance</h4>
                    </div>
                    <!--/.col (left) -->
                    <!-- /.row -->
                    <!-- left column -->
                    <!-- general form elements -->
                    <!-- Horizontal Form -->
                    <div class="card card-info">
                        <!-- form start -->
                        <div class="form-horizontal">
                            <div class="card-body">
                                <div class="form-group row">
                                    <div class="col-md-1"></div>
                                    <label for="DocNo" class="col-sm-1 col-form-label">Doc No</label>
                                    <div class="col-sm-3">
                                        <div class="input-group input-group-md">
                                            <input type="text" placeholder="Code!" class="form-control" ng-model="TxtDocNo" readonly>
                                            <span class="input-group-append">
                                                <button type="button" class="btn btn-success btn-flat" alt="default" data-toggle="modal" data-target="#DocNoLookup" href="javascript:void(0)" ng-click="GetAllData()"><i class="ti-search"></i></button>
                                                <button ng-click="GetData()" class="btn btn-warning" title="If You Want To Generate New DocNo"><i class="fa fa-plus"></i></button>
                                                @*<button ng-click="GetAllData()" class="btn btn-danger" title="If Consultacy,First Aid,Session And DocPayment Not Available Then Document Select From This Button" alt="default" data-toggle="modal" data-target="#DocNoNa" href="javascript:void(0)"><i class="ti-search"></i></button>*@
                                            </span>
                                        </div>
                                    </div>
                                    <label for="DocDate" class="col-sm-1 col-form-label">Doc Date</label>
                                    <div class="col-sm-3">
                                        <div class="input-group input-group-md">
                                            <input type="datetime-local" placeholder="Code!" class="form-control" ng-model="DT_Doc">
                                        </div>
                                    </div>
                                    <div class="col-sm-2">
                                        <div class="input-group input-group-md">
                                            <input type="text" placeholder="Shift" class="form-control" ng-model="DT_Shift">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-md-8 table-responsive text-nowrap">
                                        <table class="table table-sm table-fixed table-striped table-hover" id="example">
                                            <thead>
                                                <tr>
                                                    <th class="font-weight-bold">#</th>
                                                    <th class="font-weight-bold">Rs Value</th>
                                                    <th class="font-weight-bold">Qty</th>
                                                    <th class="font-weight-bold">Remarks</th>
                                                    <th class="font-weight-bold">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat="item in dtList">
                                                    <td>{{$index + 1}}</td>
                                                    <td><input type="text" class="form-control font-weight-bold" ng-model="item.RsNote | number:0" readonly /></td>
                                                    <td><input type="number" class="form-control" ng-model="item.Qty" ng-blur="AddTotal($index,item.Qty)" /></td>
                                                    <td><input type="text" class="form-control" ng-model="item.LineRemarks" ng-blur="AddRemarks($index, item.LineRemarks)" /></td>
                                                    <td><input type="text" class="form-control font-weight-bold text-right" ng-model="item.Total | number:2" readonly /></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col-md-4 table-responsive text-nowrap">
                                        <table class="table-sm table-hover table-bordered text-dark">
                                            <thead>
                                                <tr class="font-weight-bold" style="font-size:14px">
                                                    <th class="font-weight-bold">Sr#</th>
                                                    <th class="font-weight-bold" style="text-align:right;">Description</th>
                                                    <th class="font-weight-bold" style="text-align:right;">Amount</th>
                                                    <th class="font-weight-bold" style="text-align:right;">Amount</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat="item in DTCF">
                                                    <td>{{$index + 1}}</td>
                                                    @*<input type="text" class="form-control font-weight-bold" ng-model="item.TypeID" />*@
                                                <td>
                                                        <div class="input-group">
                                                            <select class="form-control form-input-grey" ng-model="item.TypeID">
                                                                <option value="Consultancy">Consult</option>
                                                                <option value="Doctor Payment">Doc Pay</option>
                                                                <option value="First Aid">F Aid</option>
                                                                <option value="Session">Session</option>
                                                            </select>
                                                        </div>
                                                </td>
                                                    <td><input type="number" class="form-control" ng-model="item.TotalAmount" /></td>
                                                    <td><button ng-click="OBCloseNxt()" class="btn btn-danger"><i class="fa fa-plus"></i></button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <!-- /.card-body -->
                                <hr />
                                <div class="form-group row">
                                    <div class="col-md-1"></div>
                                    <label for="Remarks" class="col-sm-1 col-form-label">Remarks</label>
                                    <div class="col-sm-5">
                                        <div class="input-group input-group-md">
                                            <input type="text" placeholder="Remarks (If Any)!" class="form-control" ng-model="TxtRemarks">

                                        </div>
                                    </div>
                                    <label for="DocTotal" class="col-sm-1 col-form-label">Doc Total</label>
                                    <div class="col-sm-3">
                                        <div class="input-group input-group-md">
                                            <input type="text" placeholder="Total!" class="form-control font-weight-bold text-right" ng-model="TxtTotalAmount" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="row p-t-30">
                                    <div class="col-md-2"></div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <button formtarget="_blank" ng-click="FinalOBSave();RptFinalOBSave();Printing()" ng-hide="CUSaveBtn" class="btn btn-outline-success form-control"><i class="fa fa-check"></i>Update</button>
                                            @*<a ng-click="Printing()" target="_blank" ng-hide="CUSaveBtn" ng-disabled="CreateDiv.$invalid" class="btn btn-outline-success form-control"><i class="fa fa-check"></i> Print</a>*@
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <button ng-click="OnDelete()" ng-hide="CUDelBtn" class="btn btn-outline-danger form-control"><i class="icon-trash"></i>Delete</button>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <button ng-click="On_Clear()" class="btn btn-outline-warning form-control"><i class="fa fa-times"></i> Clear </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

@section scripts {

    <script>

        var RegistrationForm = angular.module("RegistrationForm", []);
        RegistrationForm.controller("Home", function ($scope, $http, $window) {
            $scope.Notification = function (Type, Heading, Test) {
                //info, warning, success, error
                $.toast({
                    heading: Heading,
                    text: Test,
                    position: 'top-right',
                    loaderBg: '#ff6849',
                    icon: Type,
                    hideAfter: 3500,
                    stack: 6
                });
            };
             //=============Display Document Data Get By ID==============
            $scope.GetDataByID = function (DocNum) {
                    var displayReq = {
                        method: "POST",
                        url: "/OBEdit/Get_dataid",
                        data: {
                            DocNo: DocNum
                        }
                    }
                    $http(displayReq).then(function (Return) {
                        var dt = angular.fromJson(Return.data);
                        var total = 0;
                        var Total = 0;
                        if (dt.length > 0) {
                            for (var i = 0; i < dt.length; i++) {
                                $scope.TxtDocNo = dt[0].DocNo;
                                $scope.DT_Shift = dt[0].StaffShift;
                                $scope.DT_Doc = new Date(dt[0].EntryTime);
                                if (dt[i].TypeID != '') {
                                    $scope.DTCF[i].TypeID = dt[i].TypeID;
                                }
                                else {
                                    $scope.DTCF[i].TypeID = 'Consultancy';
                                }
                                Total = Total + dt[i].TotalAmount;
                                $scope.TxtAmounts = Total;
                                $scope.CUSaveBtn = false;
                                //$scope.CUUpdateBtn = True;
                            }
                            //$scope.DTCF[i].TypeID = 'Consultancy';
                            $scope.TxtTotalAmount = total;
                            $scope.GetRsNoteDataByID(DocNum);
                        }

                    }, function myError(Return) {
                        $scope.Notification('error', 'Error Code LC0001', Return.data);
                    });
            };
             //=============Display Document Data Get By ID If Consultancy Fa Session Or DocPayment Not Available================
            $scope.GetDocNa = function (DocNum) {
                    var displayReq = {
                        method: "POST",
                        url: "/OBEdit/Get_dataNaById",
                        data: {
                            DocNo: DocNum
                        }
                    }
                    $http(displayReq).then(function (Return) {
                        var dt = angular.fromJson(Return.data);
                        if (dt.length > 0) {
                            for (var i = 0; i < dt.length; i++) {
                                $scope.TxtDocNo = dt[0].DocNo;
                                $scope.DT_Shift = 'Shift-';
                                $scope.DT_Doc = new Date(dt[0].EntryTime);
                                $scope.CUSaveBtn = false;
                                //$scope.CUUpdateBtn = True;
                            }
                            $scope.GetRsNoteDataByID(DocNum);
                        }

                    }, function myError(Return) {
                        $scope.Notification('error', 'Error Code LC0001', Return.data);
                    });
            };
            //=============Display Document Data Get By ID================
            $scope.GetRsNoteDataByID = function (DocNum) {
                    var displayReq = {
                        method: "POST",
                        url: "/OBEdit/Get_RsNotdataid",
                        data: {
                            DocNo: DocNum
                        }
                    }
                    $http(displayReq).then(function (Return) {
                        var dt = angular.fromJson(Return.data);
                        var total = 0;
                        if (dt.length > 0) {
                            for (var i = 0; i < dt.length; i++) {
                                total = total + dt[i].Total;
                                $scope.dtList[i].RsNote = dt[i].RsNote;
                                $scope.dtList[i].Qty = dt[i].Qty;
                                $scope.dtList[i].Total = dt[i].Total;
                                $scope.dtList[i].LineRemarks = dt[i].LineRemarks;
                                $scope.TxtRemarks = dt[0].LineRemarks;
                                $scope.CUSaveBtn = false;
                                //$scope.CUUpdateBtn = True;
                            }
                            $scope.TxtTotalAmount = total;
                        }

                    }, function myError(Return) {
                        $scope.Notification('error', 'Error Code LC0001', Return.data);
                    });
            };
            //=============Get Consultancy and First Aid Data=============
            $scope.GetCF = function (ID) {
                var displayReq = {
                    method: "POST",
                    url: "/OBEdit/Get_CF",
                    data: {
                        DocNo:ID
                    }
                }
                $http(displayReq).then(function (Return) {
                    var dt = angular.fromJson(Return.data);
                    if (dt.length > 0) {
                        $scope.DTCF = angular.fromJson(Return.data);
                        $scope.GetDataByID(ID);
                    }
                    else {
                        $scope.DTCF = null;
                    }
                    //$scope.TxtTotalAmounts = TotalAmounts - TotalDocAmount;
                }, function myError(Return) {
                    $scope.Notification('error', 'Error Code LC0001', Return.data);
                });
            };
            //==============Display Docs Look up Data===================
            $scope.GetAllData = function () {
                var displayReq = {
                    method: "POST",
                    url: "/ObEdit/Get_DoLokupdata",
                    data: {
                    }
                }
                $http(displayReq).then(function (Return)
                {
                    $scope.dtGetAll = angular.fromJson(Return.data);
                    $scope.GetData();
                    //$scope.On_Clear();

                }, function myError(Return) {
                    $scope.Notification('error', 'Error Code LC0001', Return.data);
                });
            };
             //==================Print Report=======================
            $scope.Printing = function () {
            $scope.PrintingTest();
            var displayReq = {
            method: "POST",
            url: "/OBEdit/Print_Slip_Test",
            data: {
                DocNumber : $scope.TxtDocNo
                //DocDate: new Date($scope.DT_Doc)
            }
        }
            $http(displayReq).then(function (Return)
            {
                //$scope.dtGetDocHistory = angular.fromJson(Return.data);
            }, function myError(Return)
                {
                    //$scope.Clear();
                    //alert(Return.data);
            $scope.Notification('error', Return.data);
        });
            };

            $scope.PrintingTest = function () {
                $window.open('/OBEdit/Print_Slip_Test?DocNumber=' + $scope.TxtDocNo, '_blank');
            };
            //=================Insert OB Close Next Entry=======================
            $scope.OBCloseNxt = function () {
                    var displayReq = {
                        method: "POST",
                        url: "/OBEdit/AddOb_Closerecord",
                        data: {
                            DocNo: $scope.TxtDocNo,
                            DocDate: new Date($scope.DT_Doc),
                            StaffShift: $scope.DT_Shift
                        }
                    }
                    $http(displayReq).then(function (Return) {
                        if (Return.data == "Inserted") {
                            $scope.Notification('success', 'Insert New Row');
                            $scope.On_Clear();
                        }
                        else {
                            $scope.Notification('warning', 'Please Contact to Admin');
                        }
                    }, function myError(Return) {
                        $scope.Notification('error', Return.data);
                        });
            };
        //==================Final OB Insert=======================
            $scope.FinalOBSave = function () {
                //alert("Final");
                for (var i = 0; i < $scope.dtList.length; i++) {
                    var displayReq = {
                        method: "POST",
                        url: "/OBEdit/AddF_Docrecord",
                        data: {
                            DocNo: $scope.TxtDocNo,
                            DocDate: new Date($scope.DT_Doc),
                            Opening: $scope.TxtTotalAmount,
                            RsNote: $scope.dtList[i].RsNote,
                            Quantity: $scope.dtList[i].Qty,
                            LineRemarks: $scope.TxtRemarks,
                            Total: $scope.dtList[i].Total

                        }
                    }
                    $http(displayReq).then(function (Return) {
                        if (Return.data == "Updated") {
                            $scope.Notification('success', 'Opening Balance Final Update');
                            $scope.On_Clear();
                        }
                        else {
                            $scope.Notification('warning', 'Please Contact to Admin');
                        }
                    }, function myError(Return) {
                        $scope.Notification('error', Return.data);
                        });
                }
            };
             //==================For Closing Report OB Insert=======================
            $scope.RptFinalOBSave = function () {
                //alert("Final");
                for (var i = 0; i < $scope.DTCF.length; i++) {
                    var displayReq = {
                        method: "POST",
                        url: "/OBEdit/RptAddF_Docrecord",
                        data: {
                            DocNo: $scope.TxtDocNo,
                            DocDate: new Date($scope.DT_Doc),
                            TypeID: $scope.DTCF[i].TypeID,
                            TotalAmount: $scope.DTCF[i].TotalAmount,
                            StaffShift: $scope.DT_Shift
                        }
                    }
                    $http(displayReq).then(function (Return) {
                        if (Return.data == "Updated") {
                            $scope.Notification('success', 'Opening Balance Update');
                            $scope.On_Clear();
                        }
                        else {
                            $scope.Notification('warning', 'Please Contact to Admin');
                        }
                    }, function myError(Return) {
                        $scope.On_Clear();
                        $scope.Notification('error', Return.data);
                        });
                }
            };
            //==================Get Rs Note=======================
            $scope.GetData = function () {
                var displayReq = {
                    method: "POST",
                    url: "/OBEdit/NoteList",
                    data: {}
                }
                $http(displayReq).then(function (Return) {

                    var dt = angular.fromJson(Return.data);

                    if (dt.length > 0) {
                        $scope.dtList = angular.fromJson(Return.data);
                    }
                    else {
                        $scope.dtList = null;
                    }
                    $scope.CalculateGrandTotal($scope.dtList);

                }, function myError(Return) {
                    $scope.Notification('error', Return.data);
                });
            };
                $scope.AddTotal = function (row, NewValue) {
                    $scope.dtList[row].Qty = NewValue;
                    $scope.dtList[row].Total = NewValue * $scope.dtList[row].RsNote;
                    $scope.CalculateGrandTotal($scope.dtList);
                };
                $scope.AddRemarks = function (row, NewValue) {
                    $scope.dtGetRO[row].LineRemarks = NewValue;
                };
                //=================Calculate Grand Total===============
                $scope.CalculateGrandTotal = function (dt) {
                    //alert($scope.dtList);
                    var Total = 0;
                    if (dt.length > 0) {
                        for (var i = 0; i < dt.length; i++) {
                            Total = Total + dt[i].Total;
                        }
                    }
                    else {
                        Total = 0;
                    }
                    $scope.TxtTotalAmount = Total
            };
             //============Delete Document===============
            $scope.OnDelete = function () {
                var displayReq = {
                    method: "POST",
                    url: "/OBEdit/OnDelete",
                    data: {
                        DocNo: $scope.TxtDocNo
                    }
                }
                $http(displayReq).then(function (Return) {
                    $scope.On_Clear();
                    if (Return.data == "Delete") {
                        $scope.Notification('success', 'Operation Completed', 'Delete Complete Document');
                    }
                    else {
                        $scope.Notification('error', 'Error Code CU1002', 'Please Contact to Admin');
                    }
                }, function myError(Return) {
                    $scope.On_Clear();
                    $scope.Notification('error', 'Error Code CU0002', 'Please Contact to Admin');
                });
            };
                //=============Clear==========
                $scope.On_Clear = function () {
                    $scope.TxtTotalAmount = '0';
                    $scope.DT_Doc = new Date();
                    $scope.TxtRemarks = '';
                    $scope.TxtDocNo = '';
                    $scope.dtList = '';
                    $scope.DT_Shift = '';
                    $scope.DTCF = '';
                };

                $scope.OnLoad = function () {
                    $scope.TxtTotalAmount = '0';
                    $scope.DT_Doc = new Date();
                    $scope.dtList = '';
                    $scope.DTCF = '';
                };

                //==========The End==========
                $scope.OnLoad();

});


    </script>

}

