
@{
    ViewBag.Title = "OB Edit View";
}

    <div ng-app="RegistrationForm" ng-controller="Home">

        <div class="row page-titles">
            <div class="col-md-5 align-self-center">
                <h4 class="text-themecolor">Create Closing Balance</h4>
            </div>
            <div class="col-md-7 align-self-center">
                <div class="d-flex justify-content-end align-items-center">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
                        <li class="breadcrumb-item active">Create Closing Balance</li>
                    </ol>
                </div>
            </div>
        </div>
        <div id="DocNoLookup" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true" style="display: none;">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="myLargeModalLabel">Select Document Lookup</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-7">

                            </div>
                            <div class="col-md-1">
                                <label for="CompSearch">Search:</label>
                            </div>
                            <div class="col-md-4 form-material">
                                <input type="text" class="form-control" id="UserSearch" ng-model="TypeSearch" />
                            </div>
                        </div>
                        <div class="table-responsive-sm">
                            <table class="table-sm table-hover table-bordered text-dark">
                                <thead>
                                    <tr>
                                        <th>Doc No</th>
                                        <th>Doc Date</th>
                                        <th>Site ID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="item in dtGetAll | filter:TypeSearch">
                                        <td><button ng-click="GetDataByID(item.DocNo)" class="btn btn-link" data-dismiss="modal">{{item.DocNo}}</button></td>
                                        <td>{{item.DocDate | date:dd-MMM-yyyy}}</td>
                                        <td>{{item.SiteID}}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger waves-effect text-left" data-dismiss="modal">Close</button>
                    </div>
                </div>
                <!-- /.modal-content -->
            </div>
            <!-- /.modal-dialog -->
        </div>
        <!--row-->
        @*===========================Main Form============================*@
        <!-- Main content -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <!-- left column -->
                    <div class="card-header bg-info">
                        <h4 class="m-b-0 text-white">Create Closing Balance</h4>
                    </div>
                    <!--/.col (left) -->
                    <!-- /.row -->
                    <!-- left column -->
                    <!-- general form elements -->
                    <!-- Horizontal Form -->
                    <div class="card card-info">
                        <!-- form start -->
                        <div class="form-horizontal">
                            <div class="card-body">
                                <div class="form-group row">
                                    <label for="inputEmail3" class="col-sm-2 col-form-label">Consultancy</label>
                                    <div class="col-sm-2">
                                        <div class="input-group input-group-md">
                                            <input type="text" placeholder="Consultancy" class="form-control" ng-model="TxtConsultancy">
                                        </div>
                                    </div>
                                    <label for="inputEmail3" class="col-sm-1 col-form-label">First Aid</label>
                                    <div class="col-sm-2">
                                        <div class="input-group input-group-md">
                                            <input type="text" placeholder="First Aid" class="form-control" ng-model="TxtFirstAid">
                                        </div>
                                    </div>
                                    <label for="inputEmail3" class="col-sm-1 col-form-label">Sesssion</label>
                                    <div class="col-sm-2">
                                        <div class="input-group input-group-md">
                                            <input type="text" placeholder="Session" class="form-control" ng-model="TxtSession">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label for="inputEmail3" class="col-sm-2 col-form-label">Doc No</label>
                                    <div class="col-sm-3">
                                        <div class="input-group input-group-md">
                                            <input type="text" placeholder="Code!" class="form-control" ng-model="TxtDocNo">
                                            <span class="input-group-append">
                                                <button type="button" class="btn btn-success btn-flat" alt="default" data-toggle="modal" data-target="#DocNoLookup" href="javascript:void(0)" ng-click="GetAllData()"><i class="ti-search"></i></button>
                                                <button ng-click="GetData()" class="btn btn-warning" title="If You Want To Generate New DocNo"><i class="fa fa-plus"></i></button>
                                            </span>
                                        </div>
                                    </div>
                                    <label for="inputEmail3" class="col-sm-1 col-form-label">Doc Date</label>
                                    <div class="col-sm-3">
                                        <div class="input-group input-group-md">
                                            <input type="datetime-local" placeholder="Code!" class="form-control" ng-model="DT_Doc">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-md-12 table-responsive text-nowrap">
                                        <table class="table table-sm table-fixed table-striped table-hover" id="example">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Rs Value</th>
                                                    <th>Qty</th>
                                                    <th>Remarks</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat="item in dtList">
                                                    <td>{{$index + 1}}</td>
                                                    <td><input type="text" class="form-control font-weight-bold" ng-model="item.RsNote | number:0" readonly /></td>
                                                    <td><input type="number" class="form-control" ng-model="item.Qty" ng-blur="AddTotal($index,item.Qty)" /></td>
                                                    <td><input type="text" class="form-control" ng-model="item.LineRemarks" ng-blur="AddRemarks($index, item.LineRemarks)" /></td>
                                                    <td><input type="text" class="form-control font-weight-bold text-right" ng-model="item.Total | number:2" readonly /></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <!-- /.card-body -->
                                <hr />
                                <div class="form-group row">
                                    <label for="Remarks" class="col-sm-1 col-form-label">Remarks</label>
                                    <div class="col-sm-7">
                                        <div class="input-group input-group-md">
                                            <input type="text" placeholder="Remarks (If Any)!" class="form-control" ng-model="TxtRemarks">

                                        </div>
                                    </div>
                                    <label for="DocTotal" class="col-sm-1 col-form-label">Doc Total</label>
                                    <div class="col-sm-3">
                                        <div class="input-group input-group-md">
                                            <input type="text" placeholder="Total!" class="form-control font-weight-bold text-right" ng-model="TxtTotalAmount" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="row p-t-30">
                                    <div class="col-md-2"></div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <button formtarget="_blank" ng-click="FinalOBSave();RptFinalOBSave();Printing()" ng-hide="CUSaveBtn" class="btn btn-outline-success form-control"><i class="fa fa-check"></i>Update</button>
                                            @*<a ng-click="Printing()" target="_blank" ng-hide="CUSaveBtn" ng-disabled="CreateDiv.$invalid" class="btn btn-outline-success form-control"><i class="fa fa-check"></i> Print</a>*@
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <button ng-click="OnDelete()" ng-hide="CUDelBtn" class="btn btn-outline-danger form-control"><i class="icon-trash"></i>Delete</button>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <button ng-click="On_Clear()" class="btn btn-outline-warning form-control"><i class="fa fa-times"></i> Clear </button>
                                        </div>
                                    </div>
                                </div>
                                        <!-- /.card-footer -->
                                        <!-- ./row -->
                                    </div>
                                </div>
                        <!-- /.card -->
                    </div>
                    <!--/.col (left) -->
                </div>
            </div>
        </div>
        <!-- /.content -->
    </div>

@section scripts {

    <script>

        var RegistrationForm = angular.module("RegistrationForm", []);
        RegistrationForm.controller("Home", function ($scope, $http, $window) {
            $scope.Notification = function (Type, Heading, Test) {
                //info, warning, success, error
                $.toast({
                    heading: Heading,
                    text: Test,
                    position: 'top-right',
                    loaderBg: '#ff6849',
                    icon: Type,
                    hideAfter: 3500,
                    stack: 6
                });
            };
             //=============Display Document Data Get By ID================
            $scope.GetDataByID = function (ID) {
                for (var i = 0; i < $scope.dtList.length; i++) {
                    var displayReq = {
                        method: "POST",
                        url: "/OBEdit/Get_dataid",
                        data: {
                            DocNo: ID
                        }
                    }
                    $http(displayReq).then(function (Return) {
                        var dt = angular.fromJson(Return.data);
                        var total = 0;
                        if (dt.length > 0) {
                            for (var i = 0; i < dt.length; i++) {
                                total = total + dt[i].Total;
                                $scope.TxtDocNo = dt[0].DocNo;
                                $scope.TxtConsultancy = dt[0].Consultancy;
                                $scope.TxtFirstAid = dt[0].FirstAid;
                                $scope.TxtSession = dt[0].Session;
                                $scope.DT_Doc = new Date(dt[0].EntryTime);
                                $scope.TxtRemarks = dt[0].LineRemarks;
                                $scope.dtList[i].RsNote = dt[i].RsNote;
                                $scope.dtList[i].Qty = dt[i].Qty;
                                $scope.dtList[i].LineRemarks = dt[i].LineRemarks;
                                $scope.dtList[i].Total = dt[i].Total;

                                $scope.CUSaveBtn = false;
                                //$scope.CUUpdateBtn = True;
                            }
                            $scope.TxtTotalAmount = total;
                        }

                    }, function myError(Return) {
                        $scope.Notification('error', 'Error Code LC0001', Return.data);
                    });
                }
            };
            //==============Display Docs Look up Data===================
            $scope.GetAllData = function () {
                var displayReq = {
                    method: "POST",
                    url: "/ObEdit/Get_DoLokupdata",
                    data: {
                    }
                }
                $http(displayReq).then(function (Return)
                {
                    $scope.dtGetAll = angular.fromJson(Return.data);
                    $scope.GetData();
                    //$scope.On_Clear();

                }, function myError(Return) {
                    $scope.Notification('error', 'Error Code LC0001', Return.data);
                });
            };
             //==================Print Report=======================
            $scope.Printing = function () {
            $scope.PrintingTest();
            var displayReq = {
            method: "POST",
            url: "/OBEdit/Print_Slip_Test",
            data: {
                DocNumber : $scope.TxtDocNo
                //DocDate: new Date($scope.DT_Doc)
            }
        }
            $http(displayReq).then(function (Return)
            {
                //$scope.dtGetDocHistory = angular.fromJson(Return.data);
            }, function myError(Return)
                {
                    //$scope.Clear();
                    //alert(Return.data);
            $scope.Notification('error', Return.data);
        });
            };

            $scope.PrintingTest = function () {
                $window.open('/OBEdit/Print_Slip_Test?DocNumber=' + $scope.TxtDocNo, '_blank');
            };
        //==================Final OB Insert=======================
            $scope.FinalOBSave = function () {
                //alert("Final");
                for (var i = 0; i < $scope.dtList.length; i++) {
                    var displayReq = {
                        method: "POST",
                        url: "/OBEdit/AddF_Docrecord",
                        data: {
                            DocNo: $scope.TxtDocNo,
                            DocDate: new Date($scope.DT_Doc),
                            Opening: $scope.TxtTotalAmount,
                            RsNote: $scope.dtList[i].RsNote,
                            Quantity: $scope.dtList[i].Qty,
                            LineRemarks: $scope.dtList[i].LineRemarks,
                            Total: $scope.dtList[i].Total

                        }
                    }
                    $http(displayReq).then(function (Return) {
                        if (Return.data == "Updated") {
                            $scope.Notification('success', 'Opening Balance Final Update');
                            $scope.On_Clear();
                        }
                        else {
                            $scope.Notification('warning', 'Please Contact to Admin');
                        }
                    }, function myError(Return) {
                        $scope.Notification('error', Return.data);
                        });
                }
            };
             //==================For Closing Report OB Insert=======================
            $scope.RptFinalOBSave = function () {
                //alert("Final");
                for (var i = 0; i < $scope.dtList.length; i++) {
                    var displayReq = {
                        method: "POST",
                        url: "/OBEdit/RptAddF_Docrecord",
                        data: {
                            DocNo: $scope.TxtDocNo,
                            DocDate: new Date($scope.DT_Doc),
                            RsNote: $scope.dtList[i].RsNote,
                            Quantity: $scope.dtList[i].Qty,
                            Remarks: $scope.TxtRemarks,
                            Total: $scope.dtList[i].Total,
                            Consultancy:$scope.TxtConsultancy,
                            FirstAid: $scope.TxtFirstAid,
                            Session: $scope.TxtSession
                        }
                    }
                    $http(displayReq).then(function (Return) {
                        if (Return.data == "Updated") {
                            $scope.Notification('success', 'Opening Balance Update');
                            $scope.On_Clear();
                        }
                        else {
                            $scope.Notification('warning', 'Please Contact to Admin');
                        }
                    }, function myError(Return) {
                        $scope.On_Clear();
                        $scope.Notification('error', Return.data);
                        });
                }
            };
            //==================Get Rs Note=======================
            $scope.GetData = function () {
                var displayReq = {
                    method: "POST",
                    url: "/OBEdit/NoteList",
                    data: {}
                }
                $http(displayReq).then(function (Return) {

                    var dt = angular.fromJson(Return.data);

                    if (dt.length > 0) {
                        $scope.dtList = angular.fromJson(Return.data);
                    }
                    else {
                        $scope.dtList = null;
                    }
                    $scope.CalculateGrandTotal($scope.dtList);

                }, function myError(Return) {
                    $scope.Notification('error', Return.data);
                });
            };
                $scope.AddTotal = function (row, NewValue) {
                    $scope.dtList[row].Qty = NewValue;
                    $scope.dtList[row].Total = NewValue * $scope.dtList[row].RsNote;
                    $scope.CalculateGrandTotal($scope.dtList);
                };
                $scope.AddRemarks = function (row, NewValue) {
                    $scope.dtGetRO[row].LineRemarks = NewValue;
                };
                //=================Calculate Grand Total===============
                $scope.CalculateGrandTotal = function (dt) {
                    //alert($scope.dtList);
                    var Total = 0;
                    if (dt.length > 0) {
                        for (var i = 0; i < dt.length; i++) {
                            Total = Total + dt[i].Total;
                        }
                    }
                    else {
                        Total = 0;
                    }
                    $scope.TxtTotalAmount = Total
            };
             //============Delete Document===============
            $scope.OnDelete = function () {
                var displayReq = {
                    method: "POST",
                    url: "/OBEdit/OnDelete",
                    data: {
                        DocNo: $scope.TxtDocNo
                    }
                }
                $http(displayReq).then(function (Return) {
                    $scope.On_Clear();
                    if (Return.data == "Delete") {
                        $scope.Notification('success', 'Operation Completed', 'Delete Complete Document');
                    }
                    else {
                        $scope.Notification('error', 'Error Code CU1002', 'Please Contact to Admin');
                    }
                }, function myError(Return) {
                    $scope.On_Clear();
                    $scope.Notification('error', 'Error Code CU0002', 'Please Contact to Admin');
                });
            };
                //=============Clear==========
                $scope.On_Clear = function () {
                    $scope.TxtTotalAmount = '0';
                    $scope.DT_Doc = new Date();
                    $scope.TxtConsultancy = '';
                    $scope.TxtFirstAid = '';
                    $scope.TxtSession = '';
                    $scope.TxtRemarks = '';
                    $scope.TxtDocNo = '';
                    $scope.dtList = '';
                };

                $scope.OnLoad = function () {
                    $scope.TxtTotalAmount = '0';
                    $scope.DT_Doc = new Date();
                    $scope.TxtConsultancy = '';
                    $scope.TxtFirstAid = '';
                    $scope.TxtSession = '';
                    $scope.TxtRemarks = '';
                    $scope.TxtDocNo = '';
                    $scope.dtList = '';
                };

                //==========The End==========
                $scope.OnLoad();

});


    </script>

}

